/**
 * AI Workflow Wizard - CORRECTED VERSION
 * 
 * FIXES:
 * 1. Validation errors now show (display: block added)
 * 2. Debug mode button added (add ?debug=true to URL)
 * 3. Error class uses consistent 'mgrnz-status-error'
 * 
 * Copy this entire code into your WPCode JavaScript snippet
 */

document.addEventListener("DOMContentLoaded", function () {
    console.log('Wizard JavaScript loaded');
    const form = document.getElementById("ai-wizard-form");
    if (!form) {
        console.error('Form not found!');
        return;
    }
    console.log('Form found:', form);

    const totalSteps = 5;
    let currentStep = 1;

    // DOM elements
    const formWrap = document.getElementById("ai-wizard-form-wrap");
    const blueprintWrap = document.getElementById("ai-wizard-blueprint-wrap");
    const statusEl = document.getElementById("ai-wizard-status");
    const decisionStatusEl = document.getElementById("ai-wizard-decision-status");
    const stepLabel = document.getElementById("ai-step-label");
    const stepCaption = document.getElementById("ai-step-caption");
    const progressFill = document.getElementById("ai-progress-fill");
    const prevBtn = document.getElementById("ai-prev-btn");
    const nextBtn = document.getElementById("ai-next-btn");
    const submitBtn = document.getElementById("ai-submit-btn");
    const summaryEl = document.getElementById("ai-wizard-summary");
    const markdownEl = document.getElementById("ai-wizard-blueprint-markdown");
    const subscribeBtn = document.getElementById("ai-wizard-subscribe");
    const consultBtn = document.getElementById("ai-wizard-consult");
    
    console.log('Buttons found:', {
        prevBtn: !!prevBtn,
        nextBtn: !!nextBtn,
        submitBtn: !!submitBtn
    });

    // Form inputs
    const goalInput = document.getElementById("goal");
    const workflowInput = document.getElementById("workflow");
    const toolsInput = document.getElementById("tools");
    const painInput = document.getElementById("pain_points");
    const emailInput = document.getElementById("email");

    // Review elements
    const reviewGoal = document.getElementById("review-goal");
    const reviewWorkflow = document.getElementById("review-workflow");
    const reviewTools = document.getElementById("review-tools");
    const reviewPain = document.getElementById("review-pain");

    const stepCaptions = {
        1: "Your goal",
        2: "Current workflow",
        3: "Tools you use",
        4: "Pain points",
        5: "Review & email"
    };

    function updateReview() {
        if (reviewGoal) reviewGoal.textContent = goalInput.value.trim() || "Not set yet.";
        if (reviewWorkflow) reviewWorkflow.textContent = workflowInput.value.trim() || "Not set yet.";
        if (reviewTools) reviewTools.textContent = toolsInput.value.trim() || "Not set yet.";
        if (reviewPain) reviewPain.textContent = painInput.value.trim() || "Not set yet.";
    }

    function setStep(step) {
        currentStep = step;
        const steps = document.querySelectorAll(".mgrnz-ai-step");
        steps.forEach(function (el) {
            const s = parseInt(el.getAttribute("data-step"), 10);
            el.classList.toggle("active", s === currentStep);
        });

        if (stepLabel) {
            stepLabel.textContent = "Step " + currentStep + " of " + totalSteps;
        }
        if (stepCaption) {
            stepCaption.textContent = stepCaptions[currentStep] || "";
        }
        if (progressFill) {
            const progress = (currentStep / totalSteps) * 100;
            progressFill.style.width = progress + "%";
        }
        if (prevBtn) {
            prevBtn.style.visibility = currentStep === 1 ? "hidden" : "visible";
        }
        if (nextBtn && submitBtn) {
            nextBtn.style.display = currentStep === totalSteps ? "none" : "inline-flex";
            submitBtn.style.display = currentStep === totalSteps ? "inline-flex" : "none";
        }
        updateReview();
    }

    // âœ… FIXED: Now makes status visible when validation fails
    function validateCurrentStep() {
        if (!statusEl) return true;
        
        // Clear previous errors
        statusEl.textContent = "";
        statusEl.classList.remove("mgrnz-status-error");
        statusEl.style.display = "none";

        if (currentStep === 1 && !goalInput.value.trim()) {
            statusEl.textContent = "Give me at least a sentence about your goal.";
            statusEl.classList.add("mgrnz-status-error");
            statusEl.style.display = "block";  // âœ… NOW VISIBLE
            return false;
        }
        if (currentStep === 2 && !workflowInput.value.trim()) {
            statusEl.textContent = "Describe your current workflow so I have something to improve.";
            statusEl.classList.add("mgrnz-status-error");
            statusEl.style.display = "block";  // âœ… NOW VISIBLE
            return false;
        }
        if (currentStep === 5 && emailInput.value) {
            const val = emailInput.value.trim();
            const isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
            if (!isValid) {
                statusEl.textContent = "That email address doesn't look quite right.";
                statusEl.classList.add("mgrnz-status-error");
                statusEl.style.display = "block";  // âœ… NOW VISIBLE
                return false;
            }
        }
        return true;
    }

    function setLoading(isLoading) {
        if (!statusEl) return;
        if (isLoading) {
            statusEl.textContent = "Building your AI workflow blueprintâ€¦";
            statusEl.classList.remove("mgrnz-status-error");
            statusEl.style.display = "block";  // âœ… Show loading message
        }
    }

    function showDecision(message) {
        if (!decisionStatusEl) return;
        decisionStatusEl.textContent = message;
    }

    function renderMarkdown(markdown) {
        // Simple markdown to HTML conversion
        let html = markdown
            .replace(/### (.*)/g, '<h3>$1</h3>')
            .replace(/## (.*)/g, '<h2>$1</h2>')
            .replace(/# (.*)/g, '<h1>$1</h1>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>');
        
        return '<p>' + html + '</p>';
    }

    // Event listeners
    if (prevBtn) {
        prevBtn.addEventListener("click", function (e) {
            e.preventDefault();
            if (currentStep > 1) {
                setStep(currentStep - 1);
            }
        });
    }

    if (nextBtn) {
        nextBtn.addEventListener("click", function (e) {
            e.preventDefault();
            if (!validateCurrentStep()) return;
            if (currentStep < totalSteps) {
                setStep(currentStep + 1);
            }
        });
    }

    if (submitBtn) {
        submitBtn.addEventListener("click", function (e) {
            e.preventDefault();
            if (!validateCurrentStep()) return;

            setLoading(true);
            submitBtn.disabled = true;
            nextBtn && (nextBtn.disabled = true);
            prevBtn && (prevBtn.disabled = true);

            const payload = {
                goal: goalInput.value.trim(),
                workflow: workflowInput.value.trim(),
                tools: toolsInput.value.trim(),
                pain_points: painInput.value.trim(),
                email: emailInput.value.trim() || null
            };

            updateReview();

            // Get nonce from WordPress (try multiple sources)
            const nonce = (typeof wpApiSettings !== 'undefined' && wpApiSettings.nonce) 
                || (typeof wp !== 'undefined' && wp.apiFetch && wp.apiFetch.nonceMiddleware && wp.apiFetch.nonceMiddleware.nonce)
                || '';
            
            // Call the real AI API endpoint
            fetch('/wp-json/mgrnz/v1/ai-workflow', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-WP-Nonce': nonce
                },
                body: JSON.stringify(payload)
            })
            .then(function(response) {
                // Debug: log the response
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers.get('content-type'));
                
                // Get the raw text first to see what we're actually receiving
                return response.text().then(function(text) {
                    console.log('Raw response:', text.substring(0, 500));
                    
                    if (!response.ok) {
                        throw new Error('HTTP error ' + response.status);
                    }
                    
                    // Try to parse as JSON
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('JSON parse error:', e);
                        console.error('Response was:', text);
                        throw new Error('Invalid JSON response from server');
                    }
                });
            })
            .then(function(data) {
                if (data.success && data.blueprint) {
                    // Display the AI-generated blueprint (now HTML string)
                    if (summaryEl) {
                        summaryEl.textContent = "Here's your personalized AI workflow blueprint.";
                    }
                    if (markdownEl) {
                        // Blueprint is already HTML from the server
                        markdownEl.innerHTML = data.blueprint;
                    }
                    if (statusEl) {
                        const emailMsg = data.email_scheduled ? " A copy will be sent to your email." : "";
                        statusEl.textContent = "Done! Review your workflow below." + emailMsg;
                    }

                    // Show blueprint section
                    console.log('Showing blueprint...', {formWrap: !!formWrap, blueprintWrap: !!blueprintWrap});
                    if (formWrap && blueprintWrap) {
                        formWrap.style.display = "none";
                        blueprintWrap.style.display = "block";
                        console.log('Blueprint should now be visible!');
                    } else {
                        console.error('Elements not found!', {formWrap, blueprintWrap});
                    }
                } else {
                    throw new Error('Invalid response from server');
                }
            })
            .catch(function(error) {
                console.error('Blueprint generation error:', error);
                if (statusEl) {
                    statusEl.textContent = error.message || 'Unable to generate blueprint. Please try again.';
                    statusEl.classList.add("mgrnz-status-error");
                    statusEl.style.display = "block";  // âœ… Show error
                }
            })
            .finally(function() {
                submitBtn.disabled = false;
                nextBtn && (nextBtn.disabled = false);
                prevBtn && (prevBtn.disabled = false);
            });
        });
    }

    if (subscribeBtn) {
        subscribeBtn.addEventListener("click", function (e) {
            e.preventDefault();
            try {
                if (window.ml) {
                    window.ml("show", "qyrDmy", true);
                }
            } catch (err) {
                console.warn("MailerLite not available:", err);
            }
            showDecision("Nice. I'll keep you in the loop with practical AI updates.");
        });
    }

    if (consultBtn) {
        consultBtn.addEventListener("click", function (e) {
            e.preventDefault();
            const calendlyUrl = "https://calendly.com/mike-mikerobinson";
            if (window.Calendly && window.Calendly.initPopupWidget) {
                window.Calendly.initPopupWidget({ url: calendlyUrl });
            } else {
                window.open(calendlyUrl, "_blank");
            }
            showDecision("Consult booked or opened â€“ I'll meet you there.");
        });
    }

    // âœ… NEW: Debug Mode - Auto-fill test data
    function checkDebugMode() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('debug') === 'true') {
            console.log('ðŸ¤– Debug Mode Active');
            
            // Create a bright pink "Fill Test Data" button
            const debugBtn = document.createElement('button');
            debugBtn.textContent = 'ðŸ¤– Fill Test Data';
            debugBtn.className = 'mgrnz-btn mgrnz-btn-secondary';
            debugBtn.style.marginTop = '1rem';
            debugBtn.style.fontSize = '0.85rem';
            debugBtn.style.padding = '0.65rem 1.2rem';
            debugBtn.style.backgroundColor = '#ff00ff';
            debugBtn.style.borderColor = '#ff00ff';
            debugBtn.style.color = 'white';
            
            debugBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (goalInput) goalInput.value = "I want to automate my daily reporting process to save 2 hours a day.";
                if (workflowInput) workflowInput.value = "Currently I log into 3 different portals, download CSVs, merge them in Excel, and email a PDF summary to my boss.";
                if (toolsInput) toolsInput.value = "Excel, Gmail, Salesforce, Jira";
                if (painInput) painInput.value = "It's boring, prone to copy-paste errors, and takes time away from real work.";
                if (emailInput) emailInput.value = "test@example.com";
                
                // Visual feedback
                debugBtn.textContent = 'âœ… Data Filled!';
                setTimeout(() => debugBtn.textContent = 'ðŸ¤– Fill Test Data', 2000);
            });
            
            // Insert the button at the top of the form
            const wizardSection = document.querySelector('.mgrnz-ai-wizard');
            if (wizardSection && formWrap) {
                formWrap.insertBefore(debugBtn, formWrap.firstChild);
            }
        }
    }

    // Initialize
    checkDebugMode();
    setStep(1);
});
