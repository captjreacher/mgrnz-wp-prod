<!DOCTYPE html>
<html>
<head>
    <title>Chat Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        #chat-messages { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
        .chat-message { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .chat-user { background: #e3f2fd; text-align: right; }
        .chat-ai { background: #f5f5f5; }
        #chat-input { width: 100%; padding: 10px; margin-bottom: 10px; }
        button { padding: 10px 20px; background: #2196F3; color: white; border: none; cursor: pointer; }
        button:hover { background: #1976D2; }
        .typing { color: #999; font-style: italic; }
    </style>
</head>
<body>
    <h1>Chat Test</h1>
    <div>
        <label>Goal:</label>
        <input type="text" id="goal" value="Automate email management" style="width: 100%; padding: 5px; margin-bottom: 10px;">
        <label>Workflow:</label>
        <input type="text" id="workflow" value="Sort and respond to emails automatically" style="width: 100%; padding: 5px; margin-bottom: 10px;">
        <button onclick="startChat()">Start Chat</button>
    </div>
    
    <div id="chat-container" style="display: none; margin-top: 20px;">
        <div id="chat-messages"></div>
        <div id="typing" class="typing" style="display: none;">AI is thinking...</div>
        <textarea id="chat-input" rows="3" placeholder="Type your message..."></textarea>
        <button onclick="sendMessage()">Send</button>
    </div>
    
    <div id="session-info" style="margin-top: 20px; padding: 10px; background: #f0f0f0; font-family: monospace; font-size: 12px;"></div>

    <script>
        let sessionId = null;
        
        function log(msg) {
            console.log(msg);
            document.getElementById('session-info').innerHTML += msg + '<br>';
        }
        
        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = 'chat-message chat-' + sender;
            div.textContent = text;
            document.getElementById('chat-messages').appendChild(div);
            document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
        }
        
        function showTyping() {
            document.getElementById('typing').style.display = 'block';
        }
        
        function hideTyping() {
            document.getElementById('typing').style.display = 'none';
        }
        
        function startChat() {
            const goal = document.getElementById('goal').value;
            const workflow = document.getElementById('workflow').value;
            
            log('Starting chat...');
            showTyping();
            
            fetch('/wp-json/mgrnz/v1/start-chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ goal: goal, workflow: workflow })
            })
            .then(res => {
                log('Response status: ' + res.status);
                return res.json();
            })
            .then(data => {
                log('Response: ' + JSON.stringify(data));
                hideTyping();
                
                if (data.session_id) {
                    sessionId = data.session_id;
                    log('Session ID: ' + sessionId);
                    document.getElementById('chat-container').style.display = 'block';
                    if (data.message) {
                        addMessage(data.message, 'ai');
                    }
                } else {
                    log('ERROR: No session ID received');
                    alert('Error: ' + (data.message || 'Failed to start chat'));
                }
            })
            .catch(err => {
                log('ERROR: ' + err.message);
                hideTyping();
                alert('Error: ' + err.message);
            });
        }
        
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || !sessionId) {
                alert('Please enter a message and start chat first');
                return;
            }
            
            log('Sending: ' + message);
            addMessage(message, 'user');
            input.value = '';
            showTyping();
            
            fetch('/wp-json/mgrnz/v1/chat-message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId, message: message })
            })
            .then(res => {
                log('Response status: ' + res.status);
                return res.json();
            })
            .then(data => {
                log('Response: ' + JSON.stringify(data));
                hideTyping();
                
                if (data.assistant_response) {
                    addMessage(data.assistant_response, 'ai');
                    log('SUCCESS: Message displayed');
                } else if (data.message) {
                    addMessage('Error: ' + data.message, 'ai');
                    log('ERROR: ' + data.message);
                } else {
                    log('ERROR: No response in data');
                    addMessage('Error: No response received', 'ai');
                }
            })
            .catch(err => {
                log('ERROR: ' + err.message);
                hideTyping();
                addMessage('Error: ' + err.message, 'ai');
            });
        }
        
        // Allow Enter key to send
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
